As a Customer Insights Analyst for 'The General Store',lets analyse the tables to find out crucial information about the customers to provide valuable insights.
  
1. What are the names of all the countries in the country table?

SELECT distinct country_name
from country;

2. What is the total number of customers in the customers table?

SELECT COUNT(*) AS total_no_of_customers
from customers;

3. What is the average age of customers who can receive marketing emails (can_email is set to 'yes')?

select round(avg(age),0) as average_age
       from customers
       where can_email = 'yes';
       
4. How many orders were made by customers aged 30 or older?

select count(*) as no_of_orders
from customers c
join orders o using (customer_id)
where c.age >= 30;


5. What is the total revenue generated by each product category?

select p.category,
	   sum(price) as total_revenue
from products p
join baskets b using (product_id)
group by p.category;

6. What is the average price of products in the 'food' category?

select category,
	round(avg(price),2) as average_price
from products
where category = 'food';

7. How many orders were made in each sales channel (sales_channel column) in the orders table?

select sales_channel,
	   count(*) as no_of_orders
from orders
group by sales_channel;

8.What is the date of the latest order made by a customer who can receive marketing emails?


with cte as (
select customer_id,
       max(order_id) as latest_order,
       max(date_shop) as latest_order_date
from orders o
join customers c using (customer_id)
where can_email = 'yes'
group by customer_id
)select latest_order_date
from cte 
join orders o on cte.customer_id = o.customer_id and cte.latest_order = o.order_id
order by latest_order_date desc
limit 1;


-----------------------------------------------------------------------------

SELECT
    MAX(o.date_shop) AS latest_order_date
FROM
    orders o
    JOIN customers c ON o.customer_id = c.customer_id
WHERE
    c.can_email = 'yes'
GROUP BY
    o.customer_id
order by latest_order_date desc
limit 1;


---------------------------------------------------------------------


SELECT 
    MAX(IF(can_email = 'yes', date_shop, NULL)) AS latest_order_date
FROM
    orders o 
JOIN
	customers c using (customer_id)
GROUP BY
    customer_id
ORDER BY 
    latest_order_date desc
Limit 1;


--------------------------------------------------------------------

select max(date_shop) as latest_order_date
from (
	select c.customer_id,
		   o.order_id,
		   o.date_shop,
		   row_number() over(partition by c.customer_id order by o.date_shop desc) as rn
	from orders o
	join customers c using (customer_id)
	where can_email = 'yes'
	) sorted
	where rn =1
    order by latest_order_date desc
    limit 1;

9. What is the name of the country with the highest number of orders?

select country_name , count(*) as no_of_orders
from orders o 
join country c on c.country_id = o.country_id
group by country_name
order by no_of_orders desc
limit 1;

10. What is the average age of customers who made orders in the 'vitamins' product category?

with cte as (
select o.customer_id, p.product_id,p.category,o.order_id
from baskets b
join orders o using (order_id)
join products p using (product_id)
where category = 'vitamins'
)select round(avg(age),0) as average_age_of_customer
from cte 
join customers c using (customer_id);

11 What is the average price of products in each category?

select category,
	round(avg(price),2) as average_price
from products
group by category;

12. total revenue of category in each country?

select country_name,
	   sum(price) as total_revenue
from products p
join baskets b using (product_id)
join orders o using (order_id)
join country c using (country_id)
group by country_name;
